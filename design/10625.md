# EP-10625: Invalid Route Replacement

* Issue: [#10625](https://github.com/kgateway-dev/kgateway/issues/10625)

## Background

Currently, when a user adds an invalid route - for example, a route to an upstream which does not currently exist - we ellide that route from the configuration sent to Envoy. In many scenarios, this results in users making requests that would otherwise match that route, to instead receive a "No Healthy Upstream" message along with a HTTP 404.

There are scenarios where this behavior is undesirable or insufficient.

### Scenario 1: Misrouted requests

If we configure Route 1 with a prefix match for requests to `/path/bad` and Route 2 with a prefix match for requests to `/path`, and we misconfigure Route 1, then requests will be erroneously routed to Route 2. This can cause undesirable consequences, such as requests being reported as healthy 200's and hiding the error from metrics, or users being routed to the wrong service entirely.

### Scenario 2: Accidental exposure of secure routes without associated security policies configured

In this scenario we configure a Route to `/userInfo` which relies on authentication, attached via a `TrafficPolicy` for example. If there is a problem with that auth policy which might result in it not attaching - such as a bad configuration, missing backing ExtAuth server, etc - we need to make sure that the original Route does NOT propagate to the gateway. Put another way, failure of an attached security policy to a route should _also_ result in that Route being removed from that gateway, as it the route itself was misconfigured.

### Previous Approach

The 1.x implementation leveraged [envoy validate mode](https://www.envoyproxy.io/docs/envoy/latest/start/quick-start/run-envoy):

- Validation had to run on the complete xDS snapshot during translation
- No way to provide granular diffs of changes
- No guarantee of isolating impacts to specific parts of the configuration
- Safer but potentially more resource-intensive approach of validating the entire snapshot

### Gateway API Specification Compliance

The [Listener](https://gateway-api.sigs.k8s.io/reference/spec/#listener) `allowedRoutes` field states:

> Invalid Route rules can be ignored (sometimes that will mean the full Route). If a Route rule transitions from valid to invalid, support for that Route rule should be dropped…

This implies that we will drop the user’s invalid rule and replace it with an internal direct response route that always returns 404. Because the user-supplied rule is no longer supported, we remain compliant.

The [HTTPRouteRule](https://gateway-api.sigs.k8s.io/reference/spec/#httprouterule) `matches` field adds:

> When no rules matching a request have been successfully attached to the parent a request is coming from, a HTTP 404 status code MUST be returned.

The injected direct response route ensures every unmatched request receives 404, satisfying this requirement. Since 404 is mandatory, we will _not_ expose a custom response-code knob for now.

## Motivation

Implementing invalid route replacement is crucial for:

- Multi-tenancy in an environment with a shared gateway
- Ensuring no secure routes are accidentally exposed without security applied
- Making Route updates atomic - no route updates should be able to affect any other route
- Guaranteeing that an invalid route configuration does not result in unwanted traffic to another route

### Goals

- Implement invalid route replacement, for the following scenarios:
  - Configured target destination does not exist
  - Security policy applied to route is in an invalid/unaccepted state
- Enable users to disable route replacement installation wide

### Non-Goals

- Preventing all possible misconfigurations at admission time
- Provide more granular configuration options for controlling route replacement behavior
- Allow users to disable route replacement for specific routes or gateways

## Implementation Details

### Installation & Configuration

A new global setting will be added to `settings.go` to enable/disable invalid-route replacement. Default: **disabled**.

This setting will be configurable via the helm chart:

- `invalidRouteReplacement.enabled` (boolean, default: `false`)

Other response details remain fixed until finer requirements emerge.

### UX & Observability

When route replacement has been triggered, the following will occur:

- **HTTP response** — End-users receive the configured direct-response body and code (default 404)
- **Status surfaces** — Errors are propagated to the `HTTPRoute` and any offending policy CR's status
- **Logs** — A warning entry records the affected route and raw Envoy validation error

### Monitoring & Telemetry

- Gauge `invalid_route_replacements_total`
  - Labels: `gateway`, `cluster` (WIP, optional)
  - Increments each time a route is replaced because validation failed
- Counter `policy_validation_failures_total`
  - Labels: `policy_kind="TrafficPolicy"`, `namespace`, `policy`, `reason` (WIP, optional)
  - Emitted only on state change from valid -> invalid
  - Series is dropped once the policy heals, limiting label churn

### Route Replacement

#### Baseline Behavior

Today, terminal errors during route translation set the [output route to `nil`](https://github.com/kgateway-dev/kgateway/blob/85472870b35063dc4b562d3802380f5db8a75678/internal/kgateway/translator/irtranslator/route.go#L198), effectively removing it from the configuration.

#### Error Detection Points

There are several points where errors can be detected and handled:

1. [Plugin application](https://github.com/kgateway-dev/kgateway/blob/85472870b35063dc4b562d3802380f5db8a75678/internal/kgateway/translator/irtranslator/route.go#L155-L159)
   - During `ApplyForX` method execution on routes
   - If these methods return an error, the output route is set to `nil`
   - This is the primary mechanism for handling plugin-specific validation failures
   - Note: only the direct response plugin returns an error right now
2. [Policy attachment handling](https://github.com/kgateway-dev/kgateway/blob/85472870b35063dc4b562d3802380f5db8a75678/internal/kgateway/translator/irtranslator/route.go#L293-L294)
   - Errors can be present in the PolicyAtt type during policy application
   - Current limitation: These errors are not considered during route translation
   - These errors do not currently trigger route replacement
   - This represents a gap in our validation strategy that needs to be addressed
3. [Structural validation](https://github.com/kgateway-dev/kgateway/blob/85472870b35063dc4b562d3802380f5db8a75678/internal/kgateway/translator/irtranslator/route.go#L476-L493)
   - Inspects output routes before returning
   - Focuses on structural validations that are difficult to enforce at schema definition
   - Example: regex validation for route matching patterns

### Policy Attachment Validation

With the KRT-based implementation, we can validate **part** of the IR (intermediate representation) instead of the full snapshot:

- Selectively validate policies that could break data-plane health
- Avoid the performance overhead of full snapshot validation
- Provide more granular feedback about specific policy issues

#### Proposed Changes

- Replace any `nil` route with a direct-response route when the feature gate is enabled
- Consolidate all error handling at the IR level; plugins no longer bubble errors via `ApplyForX` methods
- Referential errors for policy, e.g. non-existent backing GatewayExtension provider, should be treated the same as structural errors that are highlighted by xDS validation
- Introduce a tiered validation pipeline that runs inside the plugin layer
- Route translation will respect policy wrapper errors and replace the route if the policy is invalid

### Plugin impact

- `ApplyForX` becomes a “pure mutator”: it adds filters and, if needed, appends to `ir.ValidationErrors`
- No plugin returns sentinel errors; the translator has a single place to decide replace vs keep semantics
- Inspect error handling in plugins for how referential integrity checks are handled

#### Plugin Validation Pipeline

A tiered approach to validation will be implemented:

1. **PGV validation**
  - Leverage protobuf-generated validation from the filter types stored in the IR
  - Cheap and catches most schema mistakes
  - Short circuits the rest of the validation process
2. **Partial xDS validation (via Envoy validate mode)**
  - Extract filter types from the IR and build a minimal bootstrap with those filters on a virtual host
  - Run `envoy --mode validate` against that partial config
  - If validation fails, propagate that error to the policy wrapper's `Errors` field to influence route replacement

Additional items for follow-up:

- TODO: Optimize when xDS validation runs
  - Trigger only when the policy KRT collection changes (spec, metadata) or when the related `HTTPRoute` changes (including status)
  - Investigate LRU-style caching of previous validation results
- TODO: Consider RDS-level validation

### Test Plan

- Unit: Validate all scenarios and Helm toggles
- Integration: Ensure sibling routes do not receive traffic
- E2E: End-to-end flows validating TrafficPolicy and destination failures

## Alternatives

- Continue eliding invalid routes: status quo; risks mis-routed traffic
- Admission time rejection: ideal, but not always feasible, particularly when validation involves multiple resources
- Delay pushing updates to Envoy until the entire IR validates: fallback to the last-known-good snapshot; avoids placeholder routes but requires durable storage for LKG state, coordinated rollback logic across control-plane replicas, and blocks unrelated valid changes until every error is resolved

## Open Questions

1. Decide where in helm chart the invalidRouteReplacement settings should live.
2. Confirm default values for invalidRouteReplacement settings.
3. Finalize list of policies which should trigger invalidRouteReplacement when invalid.
4. Finalize list of error scenarios at route level which should trigger invalidRouteReplacement.
5. Decide if a route in this state should be considered a Warning or an Error.
6. Some open questions about telemetry & Metrics - see Monitoring & Telemetry section.
7. Confirm if HTTP response code should be customizable or hard coded to 404.
